# PersonaForge

PersonaForge是一个为大语言模型（LLM）提供"人设包装"、多界面交互和专业工具集成的开源系统。它允许用户为模型设定特定的角色、风格和行为模式，支持命令行与Web界面，具备用户画像分析、剧本创作等多种扩展能力。

---

## 目录
1. [项目简介](#项目简介)
2. [安装与配置](#安装与配置)
3. [快速开始](#快速开始)
4. [主要功能](#主要功能)
5. [使用指南](#使用指南)
6. [角色定制](#角色定制)
7. [专业工具](#专业工具)
8. [常见问题](#常见问题)
9. [项目结构](#项目结构)
10. [历史与改进记录](#历史与改进记录)
11. [技术架构](#技术架构)
12. [贡献指南](#贡献指南)
13. [许可证](#许可证)

---

## 项目简介
PersonaForge 是一个基于 LangChain 和阿里云通义千问（DashScope API）的大语言模型人设包装与创作辅助平台。它支持：
- 通过YAML配置文件为LLM定制"人设"与行为风格
- 多界面交互（命令行、Web、演示模式）
- 用户画像分析与个性化回复
- 剧本创作、角色生成、对话生成等专业工具
- 流式输出、工具调用可视化、会话管理等增强体验

---

## 安装与配置

### 系统要求
- Python 3.8+
- pip 包管理器

### 安装步骤
```bash
git clone https://github.com/Altocumuli/Persona-Forge.git
cd PersonaForge
pip install -r requirements.txt
```

### 配置API密钥
在项目根目录创建 `.env` 文件，添加如下内容：
```
DASHSCOPE_API_KEY=your_dashscope_api_key_here
DASHSCOPE_API_BASE=https://dashscope.aliyuncs.com/compatible-mode/v1
```

---

## 快速开始

### 启动系统
```bash
python run_app.py
```
系统提供三种启动选项：
- **命令行模式**：适合开发者和进阶用户，支持在终端中与PersonaForge进行高效对话，体验流式输出、角色切换和工具调用等全部核心功能。
- **Web界面模式**：基于Streamlit，适合所有用户，提供直观的图形化操作界面，支持人设选择、会话管理、工具调用可视化、用户画像展示等丰富交互体验。
- **演示模式**：内置典型对话和工具应用示例，便于新用户快速了解PersonaForge的主要功能和最佳实践，适合教学、演示和功能预览。

---

## 主要功能
- **人设定制**：通过YAML文件为LLM设定角色、风格、行为准则
- **多界面交互**：命令行、Web、演示多模式
- **用户画像**：自动分析用户兴趣、风格、目标，实现个性化回复
- **剧本与创作工具**：剧本规划、角色档案、对话生成等
- **流式输出**：回复实时逐字显示，提升交互体验
- **工具调用可视化**：实时展示工具调用状态与结果
- **会话管理**：支持会话ID、历史保存、标签分类等

---

## 使用指南

### Web界面
- 侧边栏：会话信息、人设选择、系统设置
- 聊天区：对话历史与输入框
- 工具区：工具调用过程与结果（可开关）
- 支持流式输出、光标动画、工具调用可视化

### 命令行
- 启动：`python main.py`
- 选择人设、输入消息、实时流式回复
- 特殊命令：`exit`/`quit` 退出，`clear` 清空历史

### 常用操作
- 选择/加载人设
- 输入消息，体验流式回复
- 查看工具调用过程与结果
- 管理会话ID，切换/新建会话

---

## 角色定制

### 预设人设
- 剧本设计师、故事创作者、其他专业角色

### 创建自定义人设
1. 在 `config/personas/` 下创建 YAML 文件（如 `custom.yaml`）
2. 参考如下格式：
```yaml
name: "自定义人设名称"
role: "角色身份"
description: |
  详细的角色背景描述...
guidelines: |
  - 行为准则1
  - 行为准则2
style: |
  表达风格描述...
examples:
  - user: "示例用户问题"
    assistant: |
      示例回答内容...
llm_config:
  temperature: 0.7
  max_tokens: 1000
  top_p: 0.95
```
3. 重启系统，新人设自动加载

---

## 专业工具

### 剧本工具
- **剧本规划**：关键词"剧本/故事/电影/规划/大纲"自动触发
- **角色档案生成**：关键词"角色/人物/档案/资料"自动触发
- **对话生成**：关键词"对话/台词/对白"自动触发

### 用户偏好工具
- 自动分析兴趣主题、表达风格、对话目标，动态调整回复

---

## 常见问题

- **无法连接DashScope API**：检查`.env`文件API密钥与网络
- **流式输出无效**：确认模型支持流式，`DEFAULT_LLM_CONFIG`中`streaming=True`
- **工具调用区不显示**：Web界面设置中勾选"显示工具调用过程"
- **剧本工具未触发**：请求中需包含相关关键词
- **如何保存对话历史**：系统自动保存，Web界面可查看/恢复会话ID

---

## 项目结构
```
PersonaForge/
├── README.md                  # 项目说明文档
├── requirements.txt           # Python依赖包列表
├── main.py                    # 命令行模式入口
├── app.py                     # Web界面（Streamlit）入口
├── run_app.py                 # 启动脚本，集成多种启动模式
├── config/                    # 配置文件目录
│   ├── config.py              # 全局配置与参数
│   └── personas/              # 人设配置目录（YAML）
│       └── screenwriter.yaml  # 示例：剧本设计师人设
├── src/                       # 核心源代码
│   ├── model/                 # 模型与人设相关模块
│   │   ├── llm_config.py      # LLM参数与模型配置
│   │   └── persona.py         # 人设封装与加载
│   ├── tools/                 # 工具集实现
│   │   ├── script_tool.py     # 剧本相关工具
│   │   ├── preference_tool.py # 用户偏好分析工具
│   │   ├── param_extractor_tool.py # 参数提取工具
│   │   └── tool_registry.py   # 工具注册与管理
│   └── utils/                 # 工具类与辅助功能
│       ├── prompt_builder.py  # 提示词构建与管理
│       ├── context_manager.py # 对话上下文管理
│       └── tool_tracker.py    # 工具调用跟踪与可视化
├── history/                   # 会话历史与持久化存储（json）
│   └── session_xxx.json       # 各类会话历史文件
├── examples/                  # 示例与演示脚本
│   └── demo.py                # 示例对话与功能演示
└── docs/                      # 额外文档（如有）
```

### 结构说明
- **config/personas/**：存放所有可用人设的YAML文件，支持自定义扩展。
- **src/model/**：封装大语言模型参数与人设加载逻辑。
- **src/tools/**：实现各类专业工具（如剧本、偏好分析、参数提取等），支持扩展。
- **src/utils/**：提供提示词构建、上下文管理、工具调用跟踪等底层能力。
- **history/**：自动保存每次会话的历史记录，便于恢复和分析。
- **examples/**：包含演示脚本，帮助用户快速了解系统用法。
- **docs/**：可选，存放项目相关的补充文档或说明。
- `.env` 和 `history/` 文件夹已被加入 `.gitignore`，不会被上传到代码仓库，保护敏感信息和历史数据安全。

---

## 历史与改进记录

### 已完成改进
- 流式输出实现（Web/命令行均支持，回调机制，光标动画）
- 工具调用可视化（ToolTracker，状态/结果实时展示，颜色编码，HTML渲染）
- 用户画像增强（系统提示词增强，偏好提取优化）
- UI逻辑改进（消息顺序、工具调用显示优化，状态保存与恢复）
- HTML渲染优化（Streamlit API，响应式布局，CSS美化）

### 未来优化方向
- 多模态支持（图像输入/输出，通义千问多模态版）
- 用户自定义人设界面（图形化编辑、模板、导入导出）
- 工具集扩展（更多专业工具、用户自定义、工具组合）
- 会话管理增强（标签、搜索、分析报表）
- 性能优化（异步处理、上下文压缩、多级缓存）

---

## 技术架构
- **LangChain**：大语言模型集成与链式调用
- **阿里云通义千问**：强大LLM能力，DashScope API
- **Streamlit**：Web界面与交互
- **YAML配置**：人设与行为定制
- **Prompt工程**：提示词模板与一致性
- **上下文管理**：对话历史与用户画像
- **异常处理**：健壮的错误处理

---

## 贡献指南
欢迎贡献！可通过：
1. 提交Bug或建议
2. 贡献人设配置
3. 改进代码/文档
4. 开发新工具与功能

---

## 许可证
本项目采用MIT许可证，详见LICENSE文件。 